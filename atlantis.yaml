version: 3
automerge: true
delete_source_branch_on_merge: false
projects:
  - name: eks
    branch: dev
    dir: terraform/eks
    workspace: dev
    execution_order_group: 0
    delete_source_branch_on_merge: false
    autoplan:
      enabled: true
      when_modified: ["terraform/eks/*"]
    terraform_version: 1.2.3
    workflow: apply
  - name: eks
    branch: qa
    dir: terraform/eks
    workspace: qa
    execution_order_group: 0
    delete_source_branch_on_merge: false
    autoplan:
      enabled: true
      when_modified: ["terraform/eks/*"]
    terraform_version: 1.2.3
    workflow: apply
  - name: eks
    branch: main
    dir: terraform/eks
    workspace: prod
    execution_order_group: 0
    delete_source_branch_on_merge: false
    autoplan:
      enabled: true
      when_modified: ["terraform/eks/*"]
    terraform_version: 1.2.3
    apply_requirements: [ "approved", "mergeable" ]
    workflow: apply
  - name: eks
    branch: dev
    dir: terraform/argocd-apps
    workspace: dev
    execution_order_group: 1
    delete_source_branch_on_merge: false
    autoplan:
      enabled: true
      when_modified: ["terraform/eks/*", "terraform/argocd-apps/*"]
    terraform_version: 1.2.3
    workflow: apps-apply
  - name: eks
    branch: qa
    dir: terraform/argocd-apps
    workspace: qa
    execution_order_group: 1
    delete_source_branch_on_merge: false
    autoplan:
      enabled: true
      when_modified: ["terraform/eks/*", "terraform/argocd-apps/*"]
    terraform_version: 1.2.3
    wokflow: apps-apply
  - name: eks
    branch: main
    dir: terraform/argocd-apps
    workspace: prod
    execution_order_group: 1
    delete_source_branch_on_merge: false
    autoplan:
      enabled: true
      when_modified: ["terraform/eks/*", "terraform/argocd-apps/*"]
    terraform_version: 1.2.3
    apply_requirements: [ "approved", "mergeable" ]
    workflow: apps-apply
workflows:
  eks-apply:
    apply:
      steps:
        - apply
        - run: if [ ! -d "../../bootstrap" ];  argocd-autopilot repo bootstrap --repo  https://github.com/dahendel/sample-spring-postgres-app; fi
  apps-apply:
    apply:
      steps:
        - apply
        - run: git add ../../apps/* ../../bootstrap/*; git commit -a -m "automated commit from atlantis"; git push